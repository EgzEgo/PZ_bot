#!/usr/bin/env python3
"""
Telegram –±–æ—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏, —Ä–∞—Å—Å—ã–ª–∫–∞, –∞–Ω–∞–ª–∏–∑ –ª–æ—Ç–æ–≤ –¢–ë–∞–Ω–∫—Ä–æ—Ç —á–µ—Ä–µ–∑ ChatGPT.
"""

import json
import os
import re
import logging
from datetime import datetime, timezone, timedelta
from typing import Optional, Tuple
import httpx
from bs4 import BeautifulSoup
from openai import AsyncOpenAI

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters,
)
from telegram.error import TelegramError, Forbidden

# –ö–∞–Ω–∞–ª, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É (–±–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º –≤ –∫–∞–Ω–∞–ª–µ)
CHANNEL_USERNAME = "@bankrottorgizp"
# –°—Å—ã–ª–∫–∞ –≤ —Ç–µ–∫—Å—Ç–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è (–Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞)
CHANNEL_TEXT_LINK = "https://t.me/+5dPBAwNYbyViZTdi"
# –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫–µ ¬´–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª¬ª
CHANNEL_LINK = "https://t.me/+tBCLzbRoDNczMmNi"

# –û—Ç–≤–µ—Ç ¬´–ª–æ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω¬ª ‚Äî —Å –ø—Ä–∏–∑—ã–≤–æ–º –∑–∞–∫–∞–∑–∞—Ç—å –∞–Ω–∞–ª–∏–∑
LOT_INTERESTING_RESPONSE = (
    "–õ–æ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –¥–ª—è –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.\n\n"
    "–ß—Ç–æ–±—ã –∑–∞–∫–∞–∑–∞—Ç—å —É—Å–ª—É–≥—É –∞–Ω–∞–ª–∏–∑–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—É @zakharov_torgi."
)

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –≤ /help)
USER_INSTRUCTION = (
    "–≠—Ç–æ—Ç –±–æ—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç—Å–µ–≤–∞ –Ω–µ–ª–∏–∫–≤–∏–¥–Ω–æ–π –¥–µ–±–∏—Ç–æ—Ä—Å–∫–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏. "
    "–í–∞–∂–Ω–æ: –±–æ—Ç –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å—Ç–æ–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—É—é –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ª–æ—Ç–æ–≤, –Ω–æ –æ—Ç—Å–µ–∏–≤–∞–µ—Ç 99% –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –¥–ª—è –ø–æ–∫—É–ø–∫–∏.\n\n"
    "–ß—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª –°–µ—Ä–≥–µ—è –ó–∞—Ö–∞—Ä–æ–≤–∞: @bankrottorgizp.\n\n"
    "–ë–æ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–µ–±–∏—Ç–æ—Ä—Å–∫—É—é –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —Å –ø–ª–æ—â–∞–¥–æ–∫ ¬´–¢–ë–∞–Ω–∫—Ä–æ—Ç¬ª –∏ ¬´–§–µ–¥—Ä–µ—Å—É—Ä—Å¬ª. "
    "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ–¥—ë—Ç –∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–∏—à–ª—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —á–∞—Ç.\n\n"
    "–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –ø–∏—à–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: @zakharov_torgi."
)

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
USERS_FILE = os.path.join(BASE_DIR, "users.json")

# ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –¥–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É (—á–µ—Ä–µ–∑ BOT_ADMIN_IDS –≤ env, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
def _get_admin_ids() -> set[int]:
    raw = os.environ.get("BOT_ADMIN_IDS", "").strip()
    if not raw:
        return set()
    return {int(x.strip()) for x in raw.split(",") if x.strip().isdigit()}
ADMIN_IDS = _get_admin_ids()


async def _notify_admins_request_and_response(
    bot,
    from_user,
    request_text: str,
    response_text: str,
) -> None:
    """–ü–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–≤–µ—Ç –±–æ—Ç–∞."""
    if not ADMIN_IDS:
        return
    if not from_user:
        return
    name = from_user.first_name or ""
    username = f"@{from_user.username}" if from_user.username else "(–±–µ–∑ username)"
    user_id = from_user.id
    req = (request_text or "").strip() or "(–Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞)"
    resp = (response_text or "").strip() or "(–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞)"
    # –£–±–∏—Ä–∞–µ–º HTML-—Ç–µ–≥–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω—É
    resp_plain = re.sub(r"<[^>]+>", "", resp)
    msg = (
        f"üì© –ó–∞–ø—Ä–æ—Å –æ—Ç {name} {username}, id {user_id}\n"
        f"–¢–µ–∫—Å—Ç: {req}\n\n"
        f"ü§ñ –û—Ç–≤–µ—Ç –±–æ—Ç–∞:\n{resp_plain}"
    )
    if len(msg) > 4096:
        msg = msg[:4090] + "\n‚Ä¶"
    for admin_id in ADMIN_IDS:
        try:
            await bot.send_message(chat_id=admin_id, text=msg)
        except TelegramError as e:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—É %s: %s", admin_id, e)

# –°—Å—ã–ª–∫–∏ –Ω–∞ –ª–æ—Ç—ã: –¢–ë–∞–Ω–∫—Ä–æ—Ç –∏ –§–µ–¥—Ä–µ—Å—É—Ä—Å
TBANKROT_URL_PATTERN = re.compile(
    r"(?:https?://)?(?:www\.)?tbankrot\.ru/[^\s]+",
    re.IGNORECASE,
)
TBANKROT_DOMAIN = "tbankrot.ru"

FEDRESURS_URL_PATTERN = re.compile(
    r"(?:https?://)?(?:old\.)?bankrot\.fedresurs\.ru/[^\s]+",
    re.IGNORECASE,
)
FEDRESURS_DOMAIN = "fedresurs.ru"

# –î–æ–º–µ–Ω—ã –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –ª–æ—Ç—ã (–ø–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏)
LOT_DOMAINS = (
    (TBANKROT_URL_PATTERN, TBANKROT_DOMAIN),
    (FEDRESURS_URL_PATTERN, FEDRESURS_DOMAIN),
)


def _normalize_url(url: str) -> str:
    """–î–æ–±–∞–≤–ª—è–µ—Ç https:// –µ—Å–ª–∏ –≤ —Å—Å—ã–ª–∫–µ –Ω–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª–∞."""
    url = url.strip()
    if url and not url.startswith("http://") and not url.startswith("https://"):
        return "https://" + url
    return url
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY", "").strip()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)


def load_users() -> set[int]:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞."""
    if not os.path.isfile(USERS_FILE):
        return set()
    try:
        with open(USERS_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
        return set(data.get("user_ids", []))
    except (json.JSONDecodeError, TypeError):
        return set()


def save_user(user_id: int) -> None:
    """–î–æ–±–∞–≤–ª—è–µ—Ç user_id –≤ —Å–ø–∏—Å–æ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ñ–∞–π–ª."""
    users = load_users()
    users.add(user_id)
    with open(USERS_FILE, "w", encoding="utf-8") as f:
        json.dump({"user_ids": list(users)}, f, ensure_ascii=False)


async def post_init(application: Application) -> None:
    """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏."""
    bot = application.bot
    me = await bot.get_me()
    print("\n" + "=" * 50)
    print("  –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!")
    print(f"  –ò–º—è: @{me.username}")
    print("  –ù–∞–ø–∏—à–∏ –±–æ—Ç—É –≤ Telegram ‚Äî –æ–Ω –æ—Ç–≤–µ—Ç–∏—Ç.")
    print("=" * 50 + "\n")


def get_subscription_keyboard() -> InlineKeyboardMarkup:
    """–ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data="check_subscription")]
    ])


def get_subscribe_keyboard() -> InlineKeyboardMarkup:
    """–ö–Ω–æ–ø–∫–∏: –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª –∏ —Å–Ω–æ–≤–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª", url=CHANNEL_LINK)],
        [InlineKeyboardButton("–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data="check_subscription")],
    ])


async def is_user_subscribed(bot, user_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–¥–ø–∏—Å–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –∫–∞–Ω–∞–ª."""
    try:
        member = await bot.get_chat_member(CHANNEL_USERNAME, user_id)
        return member.status not in ("left", "kicked")
    except TelegramError:
        return False


def _extract_url_containing_domain(raw_text: str, domain: str) -> Optional[str]:
    """
    –ò—â–µ—Ç –≤ —Å—Ç—Ä–æ–∫–µ –ø–æ–¥—Å—Ç—Ä–æ–∫—É, –ø–æ—Ö–æ–∂—É—é –Ω–∞ URL –∏ —Å–æ–¥–µ—Ä–∂–∞—â—É—é domain.
    –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ—ë (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é), –∏–Ω–∞—á–µ None.
    """
    if not raw_text or domain not in raw_text.lower():
        return None
    text = raw_text.strip()
    idx = text.lower().find(domain)
    if idx < 0:
        return None
    # –ò–¥—ë–º –Ω–∞–∑–∞–¥: –¥–æ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –¥–æ –ø—Ä–æ–±–µ–ª–∞/–ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏ (–∏–ª–∏ –¥–æ ://)
    start = idx
    while start > 0 and text[start - 1] not in " \n\t\r":
        start -= 1
    # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥ –¥–æ–º–µ–Ω–æ–º –Ω–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ ‚Äî –¥–æ–±–∞–≤–∏–º –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
    head = text[start:idx]
    if not head.endswith("://") and not head.endswith("."):
        # –°—á–∏—Ç–∞–µ–º, —á—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –¥–æ–º–µ–Ω–∞
        start = idx
    # –ò–¥—ë–º –≤–ø–µ—Ä—ë–¥: –¥–æ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –¥–æ –ø—Ä–æ–±–µ–ª–∞/–ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏
    end = idx + len(domain)
    while end < len(text) and text[end] not in " \n\t\r":
        end += 1
    url = text[start:end].strip()
    if domain in url.lower():
        return _normalize_url(url)
    return None


# –ù–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–Ω–æ–≥–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —Å—Å—ã–ª–∫–∏ (–º–æ–±–∏–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –∏ —Ç.–ø.)
_INVISIBLE_CHARS = "\u200b\u200c\u200d\ufeff"  # zero-width space, ZWNJ, ZWJ, BOM


def _clean_text(s: str) -> str:
    """–£–±–∏—Ä–∞–µ—Ç –Ω–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã."""
    if not s:
        return ""
    for c in _INVISIBLE_CHARS:
        s = s.replace(c, "")
    return s.strip()


def extract_lot_links(update: Update) -> list:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –ª–æ—Ç—ã —Å tbankrot.ru –∏ fedresurs.ru –∏–∑ —Ç–µ–∫—Å—Ç–∞, caption –∏ entities.
    """
    text = _clean_text(update.message.text or "")
    caption = _clean_text(update.message.caption or "") if update.message.caption else ""
    links = []

    for raw in (text, caption):
        if not raw:
            continue

        for pattern, domain in LOT_DOMAINS:
            # 1) Regex
            for u in pattern.findall(raw):
                links.append(_normalize_url(u))

            # 2) Entities
            if update.message.entities and raw:
                for entity in update.message.entities:
                    if getattr(entity, "url", None):
                        url = (entity.url or "").strip()
                        if url and domain in url.lower():
                            links.append(_normalize_url(url))
                    elif str(getattr(entity, "type", None)) == "url":
                        start = entity.offset
                        end = entity.offset + entity.length
                        if end <= len(raw):
                            url = raw[start:end].strip()
                            if domain in url.lower():
                                links.append(_normalize_url(url))

            # 3) –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –¥–æ–º–µ–Ω—É
            found = _extract_url_containing_domain(raw, domain)
            if found:
                links.append(found)

    return list(dict.fromkeys(links))


# –ë–æ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–µ–±–∏—Ç–æ—Ä—Å–∫—É—é –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å (–ø—Ä–∞–≤–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
NOT_RECEIVABLES_MESSAGE = (
    "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è —É–º–µ—é –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–µ–±–∏—Ç–æ—Ä—Å–∫—É—é –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å"
)


def is_receivables_lot(page_text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –ª–æ—Ç –∫ –¥–µ–±–∏—Ç–æ—Ä—Å–∫–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ / –ø—Ä–∞–≤—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è.
    –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –±–æ—Ç –Ω–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–∞–∫–æ–π –ª–æ—Ç.
    """
    text_lower = page_text.lower()
    markers = (
        "–¥–µ–±–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å",
        "–ø—Ä–∞–≤–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è",
        "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫ –¥–æ–ª–∂–Ω–∏–∫—É",
        "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ–ª–∂–Ω–∏–∫–∞–º",
        "–≤–∑—ã—Å–∫–∞–Ω–∏–µ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏",
        "—É—Å—Ç—É–ø–∫–∞ –ø—Ä–∞–≤–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è",
        "–ø—Ä–∞–≤–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è",
    )
    return any(m in text_lower for m in markers)


# –ü—Ä–∞–≤–∏–ª–∞ –Ω–µ–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏: –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def evaluate_lot_by_rules(page_text: str) -> Optional[str]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –Ω–µ–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
    –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞. –ò–Ω–∞—á–µ None (–¥–∞–ª–µ–µ GPT).
    """
    text_lower = page_text.lower()
    bankrupt_markers = (
        "–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ-–±–∞–Ω–∫—Ä–æ—Ç",
        "–¥–æ–ª–∂–Ω–∏–∫ ‚Äî –±–∞–Ω–∫—Ä–æ—Ç",
        "–¥–æ–ª–∂–Ω–∏–∫ - –±–∞–Ω–∫—Ä–æ—Ç",
        "–≤ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–µ",
        "–ø—Ä–∏–∑–Ω–∞–Ω –±–∞–Ω–∫—Ä–æ—Ç–æ–º",
    )
    is_bankrupt = any(m in text_lower for m in bankrupt_markers)

    # 1) –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–æ
    liquidation_markers = (
        "–ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω",
        "–ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–æ",
        "–ª–∏–∫–≤–∏–¥–∞—Ü–∏—è",
        "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏",
        "–ª–∏–∫–≤–∏–¥–∏—Ä—É–µ—Ç—Å—è",
        "–ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–∞",
    )
    for m in liquidation_markers:
        if m in text_lower:
            return "–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ-–¥–æ–ª–∂–Ω–∏–∫ –ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–æ –∏–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏."

    # 2) –°—É–¥–µ–±–Ω—ã–π –∞–∫—Ç –æ—á–µ–Ω—å —Å—Ç–∞—Ä–æ–π –¥–∞—Ç—ã (3‚Äì4+ –ª–µ—Ç), –≤–æ–∑–±—É–∂–¥–µ–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
    if (
        "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –≤–æ–∑–±—É–∂–¥–µ–Ω–æ" in text_lower
        or "–≤–æ–∑–±—É–∂–¥–µ–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ" in text_lower
    ):
        if any(x in text_lower for x in ("–±–æ–ª–µ–µ 3 –ª–µ—Ç", "–±–æ–ª–µ–µ 4 –ª–µ—Ç", "—Å–≤—ã—à–µ 3 –ª–µ—Ç", "—Å–≤—ã—à–µ 4 –ª–µ—Ç")):
            return (
                "–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n–°—É–¥–µ–±–Ω—ã–π –∞–∫—Ç –æ—á–µ–Ω—å —Å—Ç–∞—Ä–æ–π –¥–∞—Ç—ã (3‚Äì4+ –ª–µ—Ç), "
                "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –≤–æ–∑–±—É–∂–¥–µ–Ω–æ, –¥–æ–ª–≥ –Ω–µ –≤–∑—ã—Å–∫–∞–Ω."
            )

    # 3) –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –Ω–µ –≤–æ–∑–±—É–∂–¥–µ–Ω–æ + –ø—Ä–æ–ø—É—â–µ–Ω —Å—Ä–æ–∫ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏
    if (
        "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –Ω–µ –≤–æ–∑–±—É–∂–¥–µ–Ω–æ" in text_lower
        or "–Ω–µ –≤–æ–∑–±—É–∂–¥–µ–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ" in text_lower
        or "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –Ω–µ –±—ã–ª–æ –≤–æ–∑–±—É–∂–¥–µ–Ω–æ" in text_lower
    ):
        if "–ø—Ä–æ–ø—É—â–µ–Ω —Å—Ä–æ–∫ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏" in text_lower or "—Å—Ä–æ–∫ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ–ø—É—â–µ–Ω" in text_lower:
            return (
                "–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –Ω–µ –≤–æ–∑–±—É–∂–¥–µ–Ω–æ, "
                "–ø—Ä–æ–ø—É—â–µ–Ω —Å—Ä–æ–∫ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏."
            )

    # 4/7/8) –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ-–±–∞–Ω–∫—Ä–æ—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø—Ä–∞–≤–∏–ª–∞ (—Å–Ω–∞—á–∞–ª–∞ –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ)
    if is_bankrupt:
        # 8) –í–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–µ—Å—Ç—Ä –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤ –ø–æ—Å–ª–µ –ø–æ–≥–∞—à–µ–Ω–∏—è —Ç—Ä–µ—Ç—å–µ–π –æ—á–µ—Ä–µ–¥–∏
        if any(
            x in text_lower
            for x in (
                "–≤–∫–ª—é—á–µ–Ω–∏–∏ –≤ —Ä–µ–µ—Å—Ç—Ä –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤ –ø–æ—Å–ª–µ –ø–æ–≥–∞—à–µ–Ω–∏—è —Ç—Ä–µ—Ç—å–µ–π –æ—á–µ—Ä–µ–¥–∏",
                "–≤–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–µ—Å—Ç—Ä –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤ –ø–æ—Å–ª–µ –ø–æ–≥–∞—à–µ–Ω–∏—è —Ç—Ä–µ—Ç—å–µ–π –æ—á–µ—Ä–µ–¥–∏",
                "—Ä–µ–µ—Å—Ç—Ä –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤ –ø–æ—Å–ª–µ –ø–æ–≥–∞—à–µ–Ω–∏—è —Ç—Ä–µ—Ç—å–µ–π –æ—á–µ—Ä–µ–¥–∏",
            )
        ):
            return (
                "–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ-–±–∞–Ω–∫—Ä–æ—Ç, –≤–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–µ—Å—Ç—Ä –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤ "
                "–ø–æ—Å–ª–µ –ø–æ–≥–∞—à–µ–Ω–∏—è —Ç—Ä–µ—Ç—å–µ–π –æ—á–µ—Ä–µ–¥–∏ ‚Äî 100% –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≥–∞—à–µ–Ω–∏—è."
            )
        # 7) –í–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ç—Ä–µ—Ç—å—é –æ—á–µ—Ä–µ–¥—å —Ä–µ–µ—Å—Ç—Ä–∞ –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤
        if any(
            x in text_lower
            for x in (
                "–≤–∫–ª—é—á–µ–Ω–∏–∏ –≤ —Ç—Ä–µ—Ç—å—é –æ—á–µ—Ä–µ–¥—å —Ä–µ–µ—Å—Ç—Ä–∞ –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤",
                "–≤–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ç—Ä–µ—Ç—å—é –æ—á–µ—Ä–µ–¥—å —Ä–µ–µ—Å—Ç—Ä–∞ –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤",
                "—Ç—Ä–µ—Ç—å—è –æ—á–µ—Ä–µ–¥—å —Ä–µ–µ—Å—Ç—Ä–∞ –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤",
                "—Ç—Ä–µ—Ç—å–µ–π –æ—á–µ—Ä–µ–¥–∏ —Ä–µ–µ—Å—Ç—Ä–∞ –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤",
            )
        ):
            return LOT_INTERESTING_RESPONSE
        # 4) –ü—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ-–±–∞–Ω–∫—Ä–æ—Ç
        return "–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ-–¥–æ–ª–∂–Ω–∏–∫ –ø—Ä–∏–∑–Ω–∞–Ω–æ –±–∞–Ω–∫—Ä–æ—Ç–æ–º."

    # 5) –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ –ø–µ—Ä–≤–∏—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    if any(
        x in text_lower
        for x in (
            "–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–≤–∏—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏",
            "–ø–µ—Ä–≤–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
            "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–≤–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è",
            "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–≤–∏—á–Ω–∞—è",
            "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ –ø–µ—Ä–≤–∏—á–Ω–∞—è",
            "–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–≤–∏—á–Ω–æ–π",
            "–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —á–∞—Å—Ç–∏—á–Ω–æ –ø–µ—Ä–≤–∏—á–Ω–æ–π",
        )
    ):
        return (
            "–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ –ø–µ—Ä–≤–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è."
        )

    # 6) –°—É–¥–µ–±–Ω—ã–π –∞–∫—Ç —Å—Ç–∞—Ä–æ–π –¥–∞—Ç—ã (–±–æ–ª–µ–µ 3 –ª–µ—Ç), –Ω–µ—Ç —Å–≤–µ–¥–µ–Ω–∏–π –æ –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
    if any(x in text_lower for x in ("–±–æ–ª–µ–µ 3 –ª–µ—Ç", "–±–æ–ª–µ–µ —Ç—Ä—ë—Ö –ª–µ—Ç", "—Å–≤—ã—à–µ 3 –ª–µ—Ç")):
        if any(
            x in text_lower
            for x in (
                "–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–≤–µ–¥–µ–Ω–∏—è –æ –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞",
                "–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–≤–µ–¥–µ–Ω–∏–π –æ –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞",
                "—Å–≤–µ–¥–µ–Ω–∏–π –æ –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–µ—Ç",
            )
        ):
            return (
                "–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n–°—É–¥–µ–±–Ω—ã–π –∞–∫—Ç —Å—Ç–∞—Ä–æ–π –¥–∞—Ç—ã (–±–æ–ª–µ–µ 3 –ª–µ—Ç), "
                "–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–≤–µ–¥–µ–Ω–∏—è –æ –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ ‚Äî "
                "–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≥–∞—à–µ–Ω–∏—è."
            )

    return None


async def fetch_page_text(url: str, max_chars: int = 15000) -> Optional[str]:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ URL –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç (–±–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏)."""
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0",
        "Accept": "text/html,application/xhtml+xml;q=0.9,*/*;q=0.8",
        "Accept-Language": "ru-RU,ru;q=0.9,en;q=0.8",
    }
    try:
        async with httpx.AsyncClient(timeout=30.0, follow_redirects=True) as client:
            resp = await client.get(url, headers=headers)
            resp.raise_for_status()
    except Exception as e:
        logger.warning("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ %s: %s", url, e)
        return None
    try:
        # html.parser –≤—Å—Ç—Ä–æ–µ–Ω –≤ Python, lxml –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        soup = BeautifulSoup(resp.text, "html.parser")
        for tag in soup(["script", "style", "nav", "header", "footer"]):
            tag.decompose()
        text = soup.get_text(separator="\n", strip=True)
        text = re.sub(r"\n{3,}", "\n\n", text)
        return text[:max_chars] if len(text) > max_chars else text
    except Exception as e:
        logger.warning("–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ HTML %s: %s", url, e)
        return None


def _normalize_gpt_lot_response(msg: str) -> str:
    """
    –ü—Ä–∏–≤–æ–¥–∏—Ç –æ—Ç–≤–µ—Ç GPT –∫ –æ–¥–Ω–æ–º—É –∏–∑ –¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤. –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
    (¬´–õ–æ—Ç –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –¥–ª—è –ø–æ–∫—É–ø–∫–∏¬ª, ¬´–ù–ï–Ø–°–ù–û¬ª –∏ —Ç.–ø.) –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ.
    """
    if not msg or not msg.strip():
        return msg
    text = msg.strip()
    # –°—Ç–∞—Ä—ã–µ/–∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –Ω–µ–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ ‚Üí –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    if "–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –¥–ª—è –ø–æ–∫—É–ø–∫–∏" in text.lower():
        rest = re.sub(r"(?i)–ª–æ—Ç\s+–Ω–µ\s+–∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω\s+–¥–ª—è\s+–ø–æ–∫—É–ø–∫–∏\.?\s*", "", text, count=1).strip()
        if rest:
            return f"–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n{rest}"
        return "–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n–ü–æ –ø—Ä–∞–≤–∏–ª–∞–º –∞–Ω–∞–ª–∏–∑–∞ –ª–æ—Ç –ø—Ä–∏–∑–Ω–∞–Ω –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–º."
    if "100% –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≥–∞—à–µ–Ω–∏—è" in text and "–ª–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π" not in text.lower():
        return f"–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n{text}"
    # –ù–ï–Ø–°–ù–û / –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ‚Üí –≤—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
    if "–Ω–µ—è—Å–Ω–æ" in text.lower() or "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ" in text.lower():
        return LOT_INTERESTING_RESPONSE
    # –°–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ-–ª–∏–∫–≤–∏–¥–Ω–∞—è / 90% ‚Äî —Ç—Ä–∞–∫—Ç—É–µ–º –∫–∞–∫ –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
    if "—Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ" in text.lower() and "90%" in text:
        return f"–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.\n\n{text}"
    # –£–±–∏—Ä–∞–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª/–ø—É–Ω–∫—Ç–æ–≤ –≤ –ø–æ—è—Å–Ω–µ–Ω–∏–∏
    text = re.sub(r"\s*[\(\[]?\s*(–ø–æ\s+)?–ø—Ä–∞–≤–∏–ª[—É–µ–æ–∞]?\s*\d+\s*[\)\]]?\s*[\.\,\;\:]?\s*", " ", text, flags=re.IGNORECASE)
    text = re.sub(r"\s*[\(\[]?\s*(–ø–æ\s+)?–ø—É–Ω–∫—Ç[—É–µ–æ–∞]?\s*\d+\s*[\)\]]?\s*[\.\,\;\:]?\s*", " ", text, flags=re.IGNORECASE)
    text = re.sub(r"\s*—Å–æ–≥–ª–∞—Å–Ω–æ\s+–ø—Ä–∞–≤–∏–ª[—É–µ–æ–∞]?\s*\d+\s*[\.\,\;\:]?\s*", " ", text, flags=re.IGNORECASE)
    text = re.sub(r"\s{2,}", " ", text).strip()
    if text == "–õ–æ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –¥–ª—è –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.":
        return LOT_INTERESTING_RESPONSE
    return text


# –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–∞—Ç: DD.MM.YYYY –∏–ª–∏ DD.MM.YY
_DATE_PATTERN = re.compile(
    r"\b(\d{1,2})\.(\d{1,2})\.(\d{2,4})\b"
)


def _parse_date(d: str, m: str, y: str) -> Optional[datetime]:
    """–ü–∞—Ä—Å–∏—Ç –¥–µ–Ω—å, –º–µ—Å—è—Ü, –≥–æ–¥ –≤ datetime (UTC date only)."""
    try:
        day, mon, year = int(d), int(m), int(y)
        if year < 100:
            year += 2000 if year < 50 else 1900
        if 1 <= mon <= 12 and 1 <= day <= 31:
            return datetime(year, mon, day, tzinfo=timezone.utc)
    except (ValueError, TypeError):
        pass
    return None


def _court_act_age_block(page_text: str, today: datetime) -> str:
    """
    –ò—â–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥–∞—Ç—É —Å—É–¥–µ–±–Ω–æ–≥–æ –∞–∫—Ç–∞, —Å—á–∏—Ç–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –æ—Ç today
    –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è GPT: –ø—Ä–∏–º–µ–Ω—è—Ç—å –ª–∏ –ø—É–Ω–∫—Ç—ã 2/6 –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∏–ª–∏ –Ω–µ—Ç.
    –ú–æ–¥–µ–ª—å –Ω–µ –¥–æ–ª–∂–Ω–∞ —Å–∞–º–∞ —Å—á–∏—Ç–∞—Ç—å –¥–∞—Ç—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç –≤—ã–≤–æ–¥.
    """
    if not page_text or not page_text.strip():
        return ""
    text = page_text
    text_lower = text.lower()
    # –ò—â–µ–º –¥–∞—Ç—É —Ä—è–¥–æ–º —Å ¬´—Å—É–¥–µ–±–Ω—ã–π –∞–∫—Ç¬ª, ¬´–¥–∞—Ç–∏—Ä–æ–≤–∞–Ω¬ª, ¬´–æ—Ç ‚Ä¶ –¥–∞—Ç–∞¬ª
    court_keywords = ("—Å—É–¥–µ–±–Ω—ã–π –∞–∫—Ç", "—Å—É–¥–µ–±–Ω—ã–º –∞–∫—Ç–æ–º", "—Å—É–¥–µ–±–Ω–æ–≥–æ –∞–∫—Ç–∞", "–¥–∞—Ç–∏—Ä–æ–≤–∞–Ω", "–¥–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º")
    best_date: Optional[Tuple[datetime, int]] = None  # (date, position)

    for m in _DATE_PATTERN.finditer(text):
        start, end = m.start(), m.end()
        parsed = _parse_date(m.group(1), m.group(2), m.group(3))
        if not parsed:
            continue
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç: 200 —Å–∏–º–≤–æ–ª–æ–≤ –¥–æ –∏ –ø–æ—Å–ª–µ –¥–∞—Ç—ã
        ctx_start = max(0, start - 200)
        ctx_end = min(len(text), end + 200)
        ctx = text_lower[ctx_start:ctx_end]
        if any(kw in ctx for kw in court_keywords):
            if best_date is None or start < best_date[1]:
                best_date = (parsed, start)

    if best_date is None:
        # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –¥–∞—Ç—É –≤ —Ç–µ–∫—Å—Ç–µ –∫–∞–∫ –≤–æ–∑–º–æ–∂–Ω—É—é –¥–∞—Ç—É –∞–∫—Ç–∞
        for m in _DATE_PATTERN.finditer(text):
            parsed = _parse_date(m.group(1), m.group(2), m.group(3))
            if parsed:
                best_date = (parsed, m.start())
                break

    if best_date is None:
        return (
            "–í –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–∞—Ç–∞ —Å—É–¥–µ–±–Ω–æ–≥–æ –∞–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì. "
            "–î–ª—è –ø—É–Ω–∫—Ç–æ–≤ 2 –∏ 6 –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∞–∫—Ç–∞: –≤–æ–∑—Ä–∞—Å—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, –Ω–µ –ø—Ä–∏–º–µ–Ω—è–π –ø—É–Ω–∫—Ç—ã 2/6 —Ç–æ–ª—å–∫–æ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É."
        )

    act_date = best_date[0]
    today_date = today.date() if hasattr(today, "date") else today
    if hasattr(act_date, "date"):
        act_date_only = act_date.date()
    else:
        act_date_only = act_date
    delta = today_date - act_date_only if hasattr(today_date, "__sub__") else (today - act_date)
    if isinstance(delta, timedelta):
        years = delta.days / 365.25
    else:
        years = delta.days / 365.25 if hasattr(delta, "days") else 0

    act_str = act_date.strftime("%d.%m.%Y") if hasattr(act_date, "strftime") else str(act_date_only)
    today_str = today.strftime("%d.%m.%Y")

    if years >= 3:
        return (
            f"–í –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ –Ω–∞–π–¥–µ–Ω–∞ –¥–∞—Ç–∞ —Å—É–¥–µ–±–Ω–æ–≥–æ –∞–∫—Ç–∞: {act_str}. "
            f"–°–µ–≥–æ–¥–Ω—è: {today_str}. –û—Ç –¥–∞—Ç—ã –∞–∫—Ç–∞ –ø—Ä–æ—à–ª–æ {years:.1f} –ª–µ—Ç (3 –≥–æ–¥–∞ –∏ –±–æ–ª–µ–µ). "
            "–î–ª—è –ø—É–Ω–∫—Ç–æ–≤ 2 –∏ 6 –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É —Å—É–¥–µ–±–Ω–æ–≥–æ –∞–∫—Ç–∞: –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è, –µ—Å–ª–∏ –≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ —É–∫–∞–∑–∞–Ω—ã –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –≤–æ–∑–±—É–∂–¥–µ–Ω–æ / –Ω–µ—Ç —Å–≤–µ–¥–µ–Ω–∏–π –æ –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–∏)."
        )
    else:
        months = int(years * 12) if years else 0
        return (
            f"–í –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ –Ω–∞–π–¥–µ–Ω–∞ –¥–∞—Ç–∞ —Å—É–¥–µ–±–Ω–æ–≥–æ –∞–∫—Ç–∞: {act_str}. "
            f"–°–µ–≥–æ–¥–Ω—è: {today_str}. –û—Ç –¥–∞—Ç—ã –∞–∫—Ç–∞ –ø—Ä–æ—à–ª–æ –º–µ–Ω–µ–µ 3 –ª–µ—Ç (–ø—Ä–∏–º–µ—Ä–Ω–æ {int(years)} –≥. {months % 12} –º–µ—Å.). "
            "–î–ª—è –ø—É–Ω–∫—Ç–æ–≤ 2 –∏ 6 –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É —Å—É–¥–µ–±–Ω–æ–≥–æ –∞–∫—Ç–∞: –ù–ï –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è ‚Äî –Ω–µ —Å—á–∏—Ç–∞–π –ª–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–º –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∞–∫—Ç–∞."
        )


async def ask_gpt_liquidity(page_text: str, lot_url: str) -> str:
    """
    –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç ChatGPT: —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ª–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–º –ø–æ —Ç–µ–∫—Å—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ –¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π (—Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º) –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
    """
    if not OPENAI_API_KEY:
        return "–û—à–∏–±–∫–∞: –Ω–µ –∑–∞–¥–∞–Ω OPENAI_API_KEY. –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á OpenAI –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è."
    client = AsyncOpenAI(api_key=OPENAI_API_KEY)
    system = (
        "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è. "
        "–ù–∏—á–µ–≥–æ –Ω–µ –¥–æ–¥—É–º—ã–≤–∞–π, –Ω–µ –ø—Ä–∏–ø–∏—Å—ã–≤–∞–π –æ–±—ä—è–≤–ª–µ–Ω–∏—é —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –≤ –Ω—ë–º –Ω–µ—Ç, –∏ –Ω–µ –∏—â–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. "
        "–ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —á–µ–≥–æ-—Ç–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –Ω–µ —É—Ç–≤–µ—Ä–∂–¥–∞–π —ç—Ç–æ–≥–æ. –û–ø–∏—Ä–∞–π—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏—è. "
        "–ó–ê–ü–†–ï–©–ï–ù–û –¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥ –æ –Ω–µ–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –∏–∑ –û–¢–°–£–¢–°–¢–í–ò–Ø –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –Ω–µ –Ω–∞–ø–∏—Å–∞–Ω–æ, —á—Ç–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –±–∞–Ω–∫—Ä–æ—Ç, –ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–æ –∏ —Ç.–¥. ‚Äî –Ω–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å ¬´–ª–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π¬ª –Ω–∞ —Ç–æ–º –æ—Å–Ω–æ–≤–∞–Ω–∏–∏, —á—Ç–æ ¬´–≤ —Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç —Å–≤–µ–¥–µ–Ω–∏–π¬ª –∏–ª–∏ ¬´–≤–æ–∑–º–æ–∂–Ω–æ, –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞¬ª. –ù–µ–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤ —Ç–µ–∫—Å—Ç–µ –Ø–í–ù–û —É–∫–∞–∑–∞–Ω—ã —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º (–ª–∏–∫–≤–∏–¥–∞—Ü–∏—è, –±–∞–Ω–∫—Ä–æ—Ç, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ, —Å—Ä–æ–∫ –¥–∞–≤–Ω–æ—Å—Ç–∏, –ø–µ—Ä–≤–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç.–¥.). –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—Ç–∫–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ ¬´–î–µ–±–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –û–û–û X –≤ —Ä–∞–∑–º–µ—Ä–µ Y —Ä—É–±.¬ª) –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–∞–∫–∏—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ ‚Äî –æ—Ç–≤–µ—Ç: ¬´–õ–æ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –¥–ª—è –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.¬ª\n\n"
        "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–æ—Ä–≥–∞–º –ø–æ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤—É. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å —Ç–æ–ª—å–∫–æ –ª–æ—Ç—ã ‚Äî –¥–µ–±–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å (–ø—Ä–∞–≤–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è). "
        "–ü–æ —Ç–µ–∫—Å—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–æ—Ç–∞ (–¢–ë–∞–Ω–∫—Ä–æ—Ç –∏–ª–∏ –§–µ–¥—Ä–µ—Å—É—Ä—Å) –æ–ø—Ä–µ–¥–µ–ª–∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º. "
        "–ü—Ä–∞–≤–∏–ª–∞ –Ω–µ–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏: "
        "1) –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–æ. "
        "2) –°—É–¥–µ–±–Ω—ã–π –∞–∫—Ç –æ—á–µ–Ω—å —Å—Ç–∞—Ä–æ–π –¥–∞—Ç—ã (3‚Äì4+ –ª–µ—Ç), –≤–æ–∑–±—É–∂–¥–µ–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ, –¥–æ–ª–≥ –Ω–µ –≤–∑—ã—Å–∫–∞–Ω. "
        "3) –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –Ω–µ –≤–æ–∑–±—É–∂–¥–µ–Ω–æ, –ø—Ä–æ–ø—É—â–µ–Ω —Å—Ä–æ–∫ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏. "
        "4) –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ-–±–∞–Ω–∫—Ä–æ—Ç (–∫—Ä–æ–º–µ —Å–ª—É—á–∞—è 7). "
        "5) –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ –ø–µ—Ä–≤–∏—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. "
        "6) –°—É–¥–µ–±–Ω—ã–π –∞–∫—Ç —Å—Ç–∞—Ä–æ–π –¥–∞—Ç—ã (–±–æ–ª–µ–µ 3 –ª–µ—Ç), –Ω–µ—Ç —Å–≤–µ–¥–µ–Ω–∏–π –æ –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞. "
        "7) –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ-–±–∞–Ω–∫—Ä–æ—Ç, –≤–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ç—Ä–µ—Ç—å—é –æ—á–µ—Ä–µ–¥—å —Ä–µ–µ—Å—Ç—Ä–∞ –∫—Ä–µ–¥–∏—Ç–æ—Ä–æ–≤ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è. "
        "8) –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ-–±–∞–Ω–∫—Ä–æ—Ç, –≤–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–µ—Å—Ç—Ä –ø–æ—Å–ª–µ –ø–æ–≥–∞—à–µ–Ω–∏—è —Ç—Ä–µ—Ç—å–µ–π –æ—á–µ—Ä–µ–¥–∏. "
        "–ê–õ–ì–û–†–ò–¢–ú (—Å–æ–±–ª—é–¥–∞–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º 1‚Äì8. –ü—Ä–∏–∑–Ω–∞–∫ –ø—Ä–∞–≤–∏–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–ª–æ–≤–∞/—Ñ—Ä–∞–∑—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä ¬´–ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω¬ª, ¬´–±–∞–Ω–∫—Ä–æ—Ç¬ª, ¬´–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ¬ª, ¬´—Å—Ä–æ–∫ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏¬ª, ¬´–ø–µ—Ä–≤–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è¬ª –∏ —Ç.–¥.). –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤ —Ç–µ–∫—Å—Ç–µ —Å–≤–µ–¥–µ–Ω–∏–π –æ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–µ –∏–ª–∏ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ –ù–ï –¥–∞—ë—Ç –ø—Ä–∞–≤–∞ —Å—á–∏—Ç–∞—Ç—å –ª–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–º. "
        "–ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–∞–≤–∏–ª–∞ 1, 2, 3, 4, 5, 6 –∏–ª–∏ 8 ‚Äî –æ—Ç–≤–µ—Ç—å ¬´–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.¬ª –∏ –∫—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏ –ø–æ—á–µ–º—É (–æ–ø–∏—Ä–∞—è—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–æ, —á—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ). "
        "¬´–õ–æ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –¥–ª—è –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞¬ª ‚Äî —Ç–æ–ª—å–∫–æ –≤ –¥–≤—É—Ö —Å–ª—É—á–∞—è—Ö: (–∞) –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ–¥—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª–æ 7, –∏–ª–∏ (–±) –Ω–∏ –æ–¥–Ω–æ –∏–∑ –ø—Ä–∞–≤–∏–ª 1‚Äì8 –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ —Ç–µ–∫—Å—Ç. "
        "–ù–µ –ø–∏—à–∏ ¬´–õ–æ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –¥–ª—è –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞¬ª, –µ—Å–ª–∏ –≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ —è–≤–Ω–æ –µ—Å—Ç—å –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è, –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ (–Ω–µ —Ç—Ä–µ—Ç—å—è –æ—á–µ—Ä–µ–¥—å), –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–≤–∏—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, —Å—Ç–∞—Ä—ã–π —Å—É–¥–µ–±–Ω—ã–π –∞–∫—Ç —Å –∏—Å–ø–æ–ª. –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º –∏ —Ç.–¥. ‚Äî –≤ —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö –≤—Å–µ–≥–¥–∞ ¬´–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.¬ª.\n\n"
        "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –ª–∏–±–æ ¬´–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.¬ª + 2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º, –ª–∏–±–æ —Ä–æ–≤–Ω–æ: ¬´–õ–æ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –¥–ª—è –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –ß—Ç–æ–±—ã –∑–∞–∫–∞–∑–∞—Ç—å —É—Å–ª—É–≥—É –∞–Ω–∞–ª–∏–∑–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—É @zakharov_torgi.¬ª –î—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π. –°–ª–æ–≤–æ ¬´–Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π¬ª –ø–∏—à–∏ —Å–ª–∏—Ç–Ω–æ. "
        "–í –æ–±—ä—è—Å–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞—Ç—å –Ω–æ–º–µ—Ä–∞ –ø—Ä–∞–≤–∏–ª –∏–ª–∏ –ø—É–Ω–∫—Ç–æ–≤ (–Ω–µ –ø–∏—à–∏ ¬´–ø–æ –ø—Ä–∞–≤–∏–ª—É 1¬ª, ¬´–ø—É–Ω–∫—Ç 4¬ª, ¬´—Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª—É¬ª –∏ —Ç.–ø.) ‚Äî –æ–ø–∏—à–∏ –ø—Ä–∏—á–∏–Ω—É –Ω–µ–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.\n\n"
        "–í –∑–∞–ø—Ä–æ—Å–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≥–æ—Ç–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ —Å—É–¥–µ–±–Ω–æ–≥–æ –∞–∫—Ç–∞. –î–ª—è –ø—Ä–∞–≤–∏–ª 2 –∏ 6 –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –µ–≥–æ: –µ—Å–ª–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ ¬´–ù–ï –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è¬ª –∏–ª–∏ ¬´–º–µ–Ω–µ–µ 3 –ª–µ—Ç¬ª ‚Äî –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∞–∫—Ç–∞ –ª–æ—Ç –Ω–µ –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π."
    )
    # –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ —Ä–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ —Å—É–¥–µ–±–Ω–æ–≥–æ –∞–∫—Ç–∞ –≤ –∫–æ–¥–µ ‚Äî –º–æ–¥–µ–ª—å –Ω–µ —Å—á–∏—Ç–∞–µ—Ç –¥–∞—Ç—ã —Å–∞–º–∞
    now = datetime.now(timezone.utc)
    date_str = now.strftime("%d.%m.%Y")
    court_age_block = _court_act_age_block(page_text, now)
    user_content = (
        f"–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞: {date_str}\n\n"
        f"–†–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ —Å—É–¥–µ–±–Ω–æ–≥–æ –∞–∫—Ç–∞ (—É—á–∏—Ç—ã–≤–∞–π –¥–ª—è –ø—É–Ω–∫—Ç–æ–≤ 2 –∏ 6): {court_age_block}\n\n"
        f"–°—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ—Ç: {lot_url}\n\n"
        "–ó–∞–¥–∞–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º 1‚Äì8. –ï—Å–ª–∏ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø—Ä–∞–≤–∏–ª–æ 1, 2, 3, 4, 5, 6 –∏–ª–∏ 8 ‚Äî –æ—Ç–≤–µ—Ç—å ¬´–õ–æ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã–π.¬ª —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º. –ò–Ω–∞—á–µ ‚Äî ¬´–õ–æ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –¥–ª—è –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –ß—Ç–æ–±—ã –∑–∞–∫–∞–∑–∞—Ç—å —É—Å–ª—É–≥—É –∞–Ω–∞–ª–∏–∑–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—É @zakharov_torgi.¬ª\n\n"
        "–¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–¥—É–º—ã–≤–∞–π):\n\n"
        f"{page_text}"
    )
    try:
        resp = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": system},
                {"role": "user", "content": user_content},
            ],
            max_tokens=500,
            temperature=0,  # –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥: –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ª–æ—Ç ‚Äî –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –æ—Ç–≤–µ—Ç
            seed=42,  # —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π seed –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤
        )
        msg = resp.choices[0].message.content
        if msg:
            msg = msg.replace("–Ω–µ –ª–∏–∫–≤–∏–¥–Ω", "–Ω–µ–ª–∏–∫–≤–∏–¥–Ω").strip()
            msg = _normalize_gpt_lot_response(msg)
        return msg if msg else "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏."
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ OpenAI: %s", e)
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ ChatGPT: {e!r}"


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start."""
    user = update.effective_user
    if user:
        save_user(user.id)
    start_text = (
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–æ–º ‚Äì –Ω—É–∂–Ω–æ –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –Ω–∞ —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª "
        "¬´–°–µ—Ä–≥–µ–π –ó–∞—Ö–∞—Ä–æ–≤ –ø—Ä–æ —Ç–æ—Ä–≥–∏ –ø–æ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤—É¬ª. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É¬ª. "
        "–ö–æ–º–∞–Ω–¥—ã: /start, /help."
    )
    await update.message.reply_html(
        f"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user.mention_html()}!\n\n"
        "–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–æ–º ‚Äì –Ω—É–∂–Ω–æ –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –Ω–∞ "
        f'<a href="{CHANNEL_TEXT_LINK}">—Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª ¬´–°–µ—Ä–≥–µ–π –ó–∞—Ö–∞—Ä–æ–≤ –ø—Ä–æ —Ç–æ—Ä–≥–∏ –ø–æ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤—É¬ª</a>\n\n'
        "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É¬ª, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/start ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞\n"
        "/help ‚Äî —Å–ø—Ä–∞–≤–∫–∞",
        reply_markup=get_subscribe_keyboard(),
    )
    await _notify_admins_request_and_response(
        context.bot, user,
        update.message.text or "/start",
        start_text,
    )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help."""
    if update.effective_user:
        save_user(update.effective_user.id)
    help_text = (
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n"
        "/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        f"{USER_INSTRUCTION}"
    )
    await update.message.reply_text(help_text)
    await _notify_admins_request_and_response(
        context.bot, update.effective_user,
        update.message.text or "/help",
        help_text,
    )


async def check_subscription(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–¥–ø–∏—Å–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –∫–∞–Ω–∞–ª. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É¬ª."""
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id if query.from_user else 0
    if user_id:
        save_user(user_id)
    if not user_id:
        await query.edit_message_text("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    try:
        member = await context.bot.get_chat_member(CHANNEL_USERNAME, user_id)
        # left, kicked ‚Äî –Ω–µ –≤ –∫–∞–Ω–∞–ª–µ; creator, administrator, member, restricted ‚Äî –≤ –∫–∞–Ω–∞–ª–µ
        if member.status in ("left", "kicked"):
            resp = "–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª."
            await query.edit_message_text(resp, reply_markup=get_subscribe_keyboard())
            await _notify_admins_request_and_response(
                context.bot, query.from_user, "(–∫–Ω–æ–ø–∫–∞: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É)", resp,
            )
        else:
            resp = f"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É!\n\n{USER_INSTRUCTION}"
            await query.edit_message_text(resp)
            await _notify_admins_request_and_response(
                context.bot, query.from_user, "(–∫–Ω–æ–ø–∫–∞: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É)", resp,
            )
    except TelegramError as e:
        logger.warning("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏: %s", e)
        resp = (
            "–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª.\n\n"
            "(–ï—Å–ª–∏ –≤—ã —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.)"
        )
        await query.edit_message_text(resp, reply_markup=get_subscribe_keyboard())
        await _notify_admins_request_and_response(
            context.bot, query.from_user, "(–∫–Ω–æ–ø–∫–∞: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É)", resp,
        )


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ—Ç (–¢–ë–∞–Ω–∫—Ä–æ—Ç/–§–µ–¥—Ä–µ—Å—É—Ä—Å) ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç;
    –∏–Ω–∞—á–µ –ø—Ä–æ—Å–∏—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –ª–æ—Ç.
    """
    if not update or not update.message:
        return
    if update.effective_user:
        save_user(update.effective_user.id)
    text = (update.message.text or "").strip()
    links = extract_lot_links(update)

    if links:
        user_id = update.effective_user.id if update.effective_user else 0
        if not await is_user_subscribed(context.bot, user_id):
            resp = (
                "–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª–æ—Ç–æ–≤ –Ω—É–∂–Ω–æ –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –Ω–∞ –∫–∞–Ω–∞–ª. "
                "–ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É¬ª –≤ –º–µ–Ω—é /start."
            )
            await update.message.reply_text(resp, reply_markup=get_subscribe_keyboard())
            await _notify_admins_request_and_response(
                context.bot, update.effective_user, text or links[0], resp,
            )
            return
        if not OPENAI_API_KEY:
            resp = "–ê–Ω–∞–ª–∏–∑ –ª–æ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–ª—é—á OpenAI (OPENAI_API_KEY)."
            await update.message.reply_text(resp)
            await _notify_admins_request_and_response(
                context.bot, update.effective_user, text or links[0], resp,
            )
            return
        # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—É—é —Å—Å—ã–ª–∫—É
        url = links[0]
        status_msg = await update.message.reply_text("–ó–∞–≥—Ä—É–∂–∞—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ—Ç–∞‚Ä¶")
        try:
            page_text = await fetch_page_text(url)
            if not page_text:
                resp = f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ —Å—Å—ã–ª–∫–µ.\n{url}"
                await status_msg.edit_text(resp)
                await _notify_admins_request_and_response(
                    context.bot, update.effective_user, text or url, resp,
                )
                return
            # –¢–æ–ª—å–∫–æ –¥–µ–±–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å
            if not is_receivables_lot(page_text):
                await status_msg.edit_text(NOT_RECEIVABLES_MESSAGE)
                await _notify_admins_request_and_response(
                    context.bot, update.effective_user, text or url, NOT_RECEIVABLES_MESSAGE,
                )
                return
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –Ω–µ–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
            rule_result = evaluate_lot_by_rules(page_text)
            if rule_result is not None:
                resp = f"–û—Ü–µ–Ω–∫–∞ –ª–æ—Ç–∞\n{url}\n\n{rule_result}"
                await status_msg.edit_text(
                    f"<b>–û—Ü–µ–Ω–∫–∞ –ª–æ—Ç–∞</b>\n{url}\n\n{rule_result}",
                    parse_mode="HTML",
                )
                await _notify_admins_request_and_response(
                    context.bot, update.effective_user, text or url, resp,
                )
                return
            await status_msg.edit_text("–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ª–æ—Ç")
            answer = await ask_gpt_liquidity(page_text, url)
            resp = f"–ê–Ω–∞–ª–∏–∑ –ª–æ—Ç–∞\n{url}\n\n{answer}"
            await status_msg.edit_text(
                f"<b>–ê–Ω–∞–ª–∏–∑ –ª–æ—Ç–∞</b>\n{url}\n\n{answer}",
                parse_mode="HTML",
            )
            await _notify_admins_request_and_response(
                context.bot, update.effective_user, text or url, resp,
            )
        except Exception as e:
            logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ª–æ—Ç–∞: %s", e)
            resp = (
                f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ª–æ—Ç–∞.\n{url}\n\n"
                f"–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: {e!r}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
            )
            try:
                await status_msg.edit_text(resp)
            except Exception:
                await update.message.reply_text(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ª–æ—Ç–∞: {e!r}")
            await _notify_admins_request_and_response(
                context.bot, update.effective_user, text or url, resp,
            )
        return

    resp = (
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –ª–æ—Ç —Å —Å–∞–π—Ç–∞ tbankrot.ru (–¢–ë–∞–Ω–∫—Ä–æ—Ç) –∏–ª–∏ fedresurs.ru (–§–µ–¥—Ä–µ—Å—É—Ä—Å) ‚Äî "
        "–±–æ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª–æ—Ç –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –Ω–µ–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏."
    )
    await update.message.reply_text(resp)
    await _notify_admins_request_and_response(
        context.bot, update.effective_user, text, resp,
    )


async def post_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–†–∞—Å—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞. –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤."""
    user = update.effective_user
    if not user or user.id not in ADMIN_IDS:
        await update.message.reply_text("–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
        return

    # –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞: –≤—Å—ë –ø–æ—Å–ª–µ /post –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –∏–ª–∏ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    text = " ".join(context.args) if context.args else None
    if not text:
        await update.message.reply_text(
            "–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã:\n/post –í–∞—à —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö"
        )
        return

    users = load_users()
    if not users:
        await update.message.reply_text("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.")
        return

    sent = 0
    failed = 0
    for uid in users:
        try:
            await context.bot.send_message(chat_id=uid, text=text)
            sent += 1
        except Forbidden:
            failed += 1  # –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞
        except TelegramError as e:
            logger.warning("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é %s: %s", uid, e)
            failed += 1

    await update.message.reply_text(
        f"–ì–æ—Ç–æ–≤–æ. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}, –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ (–±–ª–æ–∫/–æ—à–∏–±–∫–∞): {failed}."
    )


def main() -> None:
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞."""
    # –¢–æ–∫–µ–Ω –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN
    token = os.environ.get("TELEGRAM_BOT_TOKEN")
    if not token:
        print(
            "–û—à–∏–±–∫–∞: –∑–∞–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN.\n"
            "–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω: https://t.me/BotFather"
        )
        return

    application = (
        Application.builder()
        .token(token)
        .post_init(post_init)
        .build()
    )

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("post", post_command))
    application.add_handler(CallbackQueryHandler(check_subscription, pattern="^check_subscription$"))
    application.add_handler(
        MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message)
    )

    application.run_polling(allowed_updates=Update.ALL_TYPES)


if __name__ == "__main__":
    main()
